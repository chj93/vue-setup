FROM node:12.13.0-alpine AS builder

COPY frontend/package*.json /app/
RUN apk add --no-cache git \
  && yarn global add @vue/cli@latest \
  && cd /app && yarn serve

# Build app
# TODO: Make .env passing in runtime
ARG VUE_APP_TIMEZONE
ARG VUE_APP_LOCALE
ARG VUE_APP_FALLBACK_LOCALE
ARG VUE_APP_REST_API_KEY
ARG VUE_APP_REST_API_SERVER
ARG VUE_APP_REST_API_PREFIX
ARG VUE_APP_RECAPTCHA_SITE_KEY
ARG VUE_APP_RECAPTCHA_SECRET_KEY
ARG VUE_APP_EXTERNAL_MEDIA
ENV VUE_APP_TIMEZONE=${VUE_APP_TIMEZONE}
ENV VUE_APP_LOCALE=${VUE_APP_LOCALE}
ENV VUE_APP_FALLBACK_LOCALE=${VUE_APP_FALLBACK_LOCALE}
ENV VUE_APP_REST_API_KEY=${VUE_APP_REST_API_KEY}
ENV VUE_APP_REST_API_SERVER=${VUE_APP_REST_API_SERVER}
ENV VUE_APP_REST_API_PREFIX=${VUE_APP_REST_API_PREFIX}
ENV VUE_APP_RECAPTCHA_SITE_KEY=${VUE_APP_RECAPTCHA_SITE_KEY}
ENV VUE_APP_RECAPTCHA_SECRET_KEY=${VUE_APP_RECAPTCHA_SECRET_KEY}
ENV VUE_APP_EXTERNAL_MEDIA=${VUE_APP_EXTERNAL_MEDIA}
COPY frontend/ /app/
RUN cd /app && yarn build

FROM nginx:1.21.0-alpine

COPY --from=builder /app/dist /usr/share/nginx/html
